<?php

namespace App\Http\Controllers;

use App\Imports\UsersImport;
use App\Jobs\ProcessJsonUpload;
use App\Models\Domain;
use App\Models\LGA;
use App\Models\Subdomain;
use App\Models\SurveyData;
use App\Models\SurveyResponse;
use App\Models\User;
use App\Services\UserService;
use App\Transformers\UtilResource;
use GenderDetector\GenderDetector;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Validation\ValidationException;
use Maatwebsite\Excel\Facades\Excel;
use Illuminate\Http\File;
use Illuminate\Support\Facades\Storage;

class UserController extends Controller
{
    public function __construct(protected UserService $userService)
    {
        
    }

    public function index()
    {
        try {            
            $users = $this->userService->getAllUsers();
            return new UtilResource($users, false, 200);
        } catch (\Exception $e) {
            return new UtilResource($e->getMessage(), true, 400);
        }
    }

    public function show($id)
    {
        try {
            $user = $this->userService->getUserById($id);
            return new UtilResource($user, false, 200);
        } catch (\Exception $e) {
            return new UtilResource($e->getMessage(), true, 400);
        }
    }

    public function store(Request $request)
    {
        try {
            // Validation rules and custom error messages
            $rules = [
                'name' => 'required|string',
                'email' => 'required|email|unique:users,email',
                'gender' => 'required|string',
                'age' => 'required|integer',
                'ward_ids' => 'required|array',
                'phone_number' => 'required|string',
            ];

            $messages = [
                'name.required' => 'Name is required.',
                'email.required' => 'Email is required.',
                'email.email' => 'Invalid email format.',
                'email.unique' => 'Email is already taken.',
                // Add more custom error messages as needed
            ];

            // Validate the request data
            $request->validate($rules, $messages);

            // Create a new user
            $user = User::create([
                'name' => $request->input('name'),
                'email' => $request->input('email'),
                'gender' => $request->input('gender'),
                'age' => $request->input('age'),
                'ward_ids' =>implode(',',$request->input('ward_ids')),
                'phone_number' => $request->input('phone_number'),
            ]);

            if ($user) {
                return redirect()->route('upload.excel')->with('success', 'User added successfully.');
            } else {
                return redirect()->route('upload.excel')->with('error', 'Failed to add user.');
            }
        } catch (ValidationException $e) {
            return redirect()->route('upload.excel')->with('error', $e->getMessage())->withErrors($e->errors());
        } catch (\Exception $e) {
            return redirect()->route('upload.excel')->with('error', 'An error occurred while adding the user.');
        }
    }

    public function questions(){
        
        try{
            $response = Subdomain::get();
            return response()->json([
                'status' => 'success',
                'message' =>$response
            ]);
        }catch(\Exception $e){
            return response()->json([                
                'message' => $e->getMessage()
            ], 400);
        }
    }


    public function lgas(){
        
        try{
            $response = LGA::with('wards')->get();
            return response()->json([
                'status' => 'success',
                'message' =>$response
            ]);
        }catch(\Exception $e){
            return response()->json([                
                'message' => $e->getMessage()
            ], 400);
        }
    }
    
    public function importExcel(Request $request)
    {
        $file = $request->file('file');

        Excel::import(new UsersImport, $file);

        return redirect()->route('users.index')
            ->with('success', 'Excel data imported to users table successfully.');
    }

    public function userIndex()
    {
        $users = User::latest()->get();
        return view('users_index', ['users' => $users]);
    }

    public function uploadIndex()
    {        
        return view('upload_excel');
    }
    
    public function uploadData(Request $request){
        try{
            $request->validate([
                'data'=>'required',
                'user_id'=>'required'
            ]);
            $data = $request->input('data');
            $formatted = [];
            $now = now(); // Assuming now() returns the current timestamp.            
            foreach ($data as $dat) {
                $token = $request->input('user_id').'_'.rand(1000000000000000,9999999999999999);
                foreach ($dat as $d) {
                    $formatted[] = [
                        'user_id'=> $request->input('user_id'),
                        'domain_id' => $d['domain_id'],
                        'subdomain_id' => $d['id'],
                        'answer' => $d['answer'],
                        'token' =>$token,
                        'created_at' => $now,
                    ];
                }
            }
            
            if (!empty($formatted)) {
                SurveyResponse::insert($formatted);
            }
            return response()->json([
                'status' => 'success',
                'message' =>'Uploaded'
            ]);
        }catch(\Exception $e){
            return response()->json([                
                'message' => $e->getMessage()
            ], 400);
        }
    }
    

    public function getAllResponses()
    {
            // Fetch the data            
        $domain_id = 8;
        $responses = DB::table('survey_responses')
        ->join('subdomains', 'survey_responses.subdomain_id', '=', 'subdomains.id')
        ->select('survey_responses.token', 'subdomains.name as subdomain_name', 'survey_responses.answer')
        ->where('subdomains.domain_id', $domain_id)
        ->get();

        // Create an associative array for the dynamic columns
        $dynamicColumns = [];

        foreach ($responses as $response) {
        $token = $response->token;
        $subdomainName = $response->subdomain_name;
        $answer = $response->answer;

        // Use the subdomain name as a key and token as a value
        $dynamicColumns[$token][$subdomainName] = $answer;
        }

        // Now you have an associative array where the keys are tokens and values are arrays with subdomain names and answers

        return response()->json(['responses' => $dynamicColumns]);
    }

    public function uploadJsonindex()
    {
        return view('json_upload'); // Assuming you have a Blade view named 'upload.blade.php'
    }
    public function uploadJson(Request $request) {
        // Validate the request
        $request->validate([
            'file' => 'required',
            'zone' => 'required|in:ZONE_A,ZONE_B,ZONE_C', // Add more zones as needed
        ]);
    
        $zone = $request->zone;
    
        // Retrieve the uploaded JSON file
        //$file = $request->file('file')->path();   
        //$file= $request->file('file')->store('uploads');  
         // Get the path to the "public" directory
        $publicPath = public_path();

        // Store the uploaded file in the "public" directory with a custom name
        $file = '';//$request->file('file')->move($publicPath, $zone.'.json');

      // Dispatch the job with the relevant data
      ProcessJsonUpload::dispatch('name', $zone);        
      return response()->json(['message' => 'Data processing job has been dispatched'. $file]);
        // Return a response indicating that the job has been dispatched
    }
    
    public  function fetch(Request $request){
        try{

            $zone = $request->zone??"ZONE_A";
            $surveyData = SurveyData::select('1_Data_Collectors_ID','2_Ward','9_Age_Range','10_Marital_Status','11_Gender')->search($zone)->get();
            return $surveyData;
        }catch(\Exception $e){
            return $e->getMessage();
        }
        //return response()->json($surveyData);
    }

    public function report()
    {  
        $min = [0, 1.5];
        $med = [1.5, 3];
        $max = [3, 5.0];
        $lgas_wards  = DB::select(DB::raw('SELECT COUNT(s.id) as total, d.ward, d.lga FROM `survey` s JOIN survey_data d ON s.ec5_uuid = d.ec5_uuid GROUP BY d.ward, d.lga '));
        $wards_lga = [];
        foreach ($lgas_wards as $chk) {
            $wards_lga[$chk->lga==''?'Unknown':$chk->lga][] = $chk;
        }        
         
        $domain_dist = DB::select(DB::raw('SELECT COUNT(*) AS count, AVG(score) AS mean, STDDEV_POP(score) AS std, MIN(score) AS min, MAX(score) AS max,  
        SUM(CASE WHEN score BETWEEN ' . $min[0] . ' AND ' . $min[1] . ' THEN 1 ELSE 0 END) AS q25, 
        SUM(CASE WHEN score BETWEEN ' . $med[0] . ' AND ' . $med[1] . ' THEN 1 ELSE 0 END) AS median, 
        SUM(CASE WHEN score BETWEEN ' . $max[0] . ' AND ' . $max[1] . ' THEN 1 ELSE 0 END) AS q75 ,
        domain
        FROM ( SELECT score, domain FROM survey ) AS percentiles GROUP BY domain'));

            
        $gender_dist  = DB::select(DB::raw('SELECT COUNT(*) AS count, AVG(score) AS mean, STDDEV_POP(score) AS std, MIN(score) AS min, MAX(score) AS max, SUM(CASE WHEN score BETWEEN ' . $min[0] . ' AND ' . $min[1] . ' THEN 1 ELSE 0 END) AS q25, SUM(CASE WHEN score BETWEEN ' . $med[0] . ' AND ' . $med[1] . ' THEN 1 ELSE 0 END) AS median, SUM(CASE WHEN score BETWEEN ' . $max[0] . ' AND ' . $max[1] . ' THEN 1 ELSE 0 END) AS q75 , gender FROM ( SELECT score, 11_Gender AS gender FROM survey ) AS percentiles GROUP BY  gender;'));
        $lgas  = DB::select(DB::raw('SELECT COUNT(s.id) as total, d.lga FROM `survey` s JOIN survey_data d ON s.ec5_uuid = d.ec5_uuid GROUP BY d.lga '));
        
        //$demographic  = DB::select(DB::raw('SELECT  SUM(IF(s.11_Gender = "FEMALE", 1,0)) as female, SUM(IF(s.11_Gender = "MALE", 1,0)) as male,  SUM(IF(s.Are_you_currently > 0, 1,0)) as total_pregnant, SUM(IF(s.Are_you_currently < 1, 1,0)) as total_not_pregnant, SUM(IF(d.36_How_many_children>2,2, d.36_How_many_children)) total_children FROM `survey` s JOIN survey_data d ON s.ec5_uuid = d.ec5_uuid;'));
        //$wards  = DB::select(DB::raw('SELECT  SUM(IF(s.11_Gender = "FEMALE", 1,0)) as female, SUM(IF(s.11_Gender = "MALE", 1,0)) as male,  SUM(IF(s.Are_you_currently > 0, 1,0)) as total_pregnant, SUM(IF(s.Are_you_currently < 1, 1,0)) as total_not_pregnant, SUM(IF(d.36_How_many_children>2,2, d.36_How_many_children)) total_children FROM `survey` s JOIN survey_data d ON s.ec5_uuid = d.ec5_uuid;'));
        $domain_dist = collect($domain_dist);        
        $poor =   $domain_dist->where('domain','poor')->first();        
        $disability =   $domain_dist->where('domain','disability')->first();
        $women_children_under_5 =  $domain_dist->where('domain','women_children_5')->first();
        $IDP  =  $domain_dist->where('domain','idp')->first();
        $elderly =  $domain_dist->where('domain','elderly')->first();
        $sex_worker_truck_driver =  $domain_dist->where('domain','sex_worker_truck')->first();
        $other =  $domain_dist->where('domain','other_domain')->first();        

        $gender_dist = collect($gender_dist);
        $male_dist = $gender_dist->where('gender','MALE')->first();
        $female_dist = $gender_dist->where('gender','FEMALE')->first();
        $total_captured = DB::select(DB::raw('select count(id) as total from survey'))[0]->total;
        return view('report', compact('wards_lga','total_captured','poor', 'lgas','disability', 'women_children_under_5', 'IDP', 'elderly', 'sex_worker_truck_driver', 'other','male_dist','female_dist'));

    }

    public function genderDetector(){
        $elderly = DB::select(DB::raw('SELECT ec5_uuid FROM survey WHERE 11_Gender = ""'));
        $chunks = collect($elderly)->chunk(2100);        
        $chunks = $chunks->toArray();
        $chunk1 = [];
        foreach( $chunks[0] as $ch ){
        $chunk1[]= '"'.$ch->ec5_uuid.'"';
        }

        $chunk2 = [];
        foreach( $chunks[1] as $ch ){
            $chunk2[]= '"'.$ch->ec5_uuid.'"';
        }        
        DB::select(DB::raw("UPDATE survey SET `11_gender` = 'FEMALE' where ec5_uuid IN (".implode(',', $chunk1).")"));
        DB::select(DB::raw("UPDATE survey SET `11_gender` = 'MALE' where ec5_uuid IN (".implode(',', $chunk2).")"));
        return 'completed';
    }
}
